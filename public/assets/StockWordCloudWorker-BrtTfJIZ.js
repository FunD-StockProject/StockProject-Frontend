(function(){"use strict";const D=(a,X,o,m,i,b,C,M,k)=>{const S=(t,l,c,x)=>Y[(l+x)*(o+1)+(t+c)]-(Y[l*(o+1)+(t+c)]+Y[(l+x)*(o+1)+t])+Y[l*(o+1)+t]===0,g=(t,l,c,x,f)=>{const[e,r]=[c+~~(x?l:t.width*l),c+~~(x?t.width*l:l)];let[u,s]=[0,0],[v,z,d]=[0,0,0],p=[];for(u=0;u<X-r;u++)for(s=0;s<o-e;s++){if(I[u+o+(s+e-1)]){s+=e-1;continue}if(!I[u*o+s]){for(;s<o-e&&!S(s,u,e,1);){for(v=s,d=s+e,z=0;v+1<d;)z=v+d>>1,S(z,u,s+e-z,1)?d=z:v=z;s=z}S(s,u,e,r)&&p.push(u*o+s)}}return p.length?p[f%p.length]:null},O=(t,l,c,x,f)=>{let[e,r]=[0,0];for(e=c;e<c+f;e++)for(r=l;r<l+x;r++)I[e*o+r]=t[(e-c)*x*4+(r-l)*4+3]?1:0;for(e=c;e<X;e++)for(r=l;r<o;r++)Y[(e+1)*(o+1)+(r+1)]=Y[e*(o+1)+(r+1)]+Y[(e+1)*(o+1)+r]-Y[e*(o+1)+r]+I[e*o+r]};a=a.sort((t,l)=>l.value-t.value).slice(0,b);const T=a[0].value,P=new OffscreenCanvas(o,1).getContext("2d");if(!P)return null;a=Array.from(a,t=>({text:t.text,value:t.value/T}));let y=1,n=1,F=[],A;const Y=new Int32Array((X+1)*(o+1)),I=new Int32Array(X*o);if(k)n=k;else if(a.length==1)n=X;else{const t=D(a.slice(0,2),X,o,m,i,b,C,M,X);if(!t)return null;if(t.length>=2)n=~~(2*t[0].fontSize*t[1].fontSize/(t[0].fontSize+t[1].fontSize));else if(t.length==1)n=t[0].fontSize;else return null}A=new Array(n+1);for(let t=0;t<=n;t++)A[t]=`${t}px Pretendard black`;P.font=A[1];for(const t of a){const l=t.text,c=t.value;if(c==0)continue;let x=null,f=null;n=~~((C*(t.value/y)+(1-C))*n);let e=Math.random()>=.9,r=!1;const u=P.measureText(l);for(;!(n<m);){const p=g(u,n,i,e,M);if(p!=null){f={posX:p%o,posY:~~(p/o),sizeX:i+~~(e?n:u.width*n),sizeY:i+~~(e?u.width*n:n),spanX:p%o+i/2,spanY:~~(p/o)+i/2,textX:p%o+i/2-(e?n*.055:0),textY:~~(p/o)+i/2+(e?0:n*.055)};break}r?(n-=1,e=!1):(e=!0,r=!0)}if(n<m)break;if(!f)continue;const s=new OffscreenCanvas(f.sizeX,f.sizeY).getContext("2d");if(!s)return null;s.font=A[n];const v=i/2-(e?n*.055:0),z=i/2+(e?0:n*.055);e?(s.textBaseline="bottom",s.rotate(90*Math.PI/180),s.fillText(t.text,z,-v),s.rotate(-90*Math.PI/180)):(s.textBaseline="top",s.fillText(t.text,v,z)),x={word:l,freq:c,fontSize:n,position:{x:f.spanX,y:f.spanY},size:{w:f.sizeX,h:f.sizeY},orientation:e,color:"black"},F.push(x);const d=s.getImageData(0,0,f.sizeX,f.sizeY);O(d.data,~~f.posX,~~f.posY,~~f.sizeX,~~f.sizeY),y=t.value}return F};self.onmessage=a=>{console.log(a);const X=a.data.data,o=a.data.height??300,m=a.data.width??300,i=a.data.minFontSize??4,b=a.data.margin??2,C=a.data.maxWords??200,M=a.data.relativeScaling??.5,k=a.data.randomState??Math.round(Math.random()*1e9),S=a.data.maxFontSize;postMessage(D(X,o,m,i,b,C,M,k,S))}})();
